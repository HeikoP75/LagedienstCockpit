<!DOCTYPE html>
<html lang="de">
<head>

<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

<meta charset="UTF-8">
<title>FEUER ‚Äì Einsatzdokumentation</title>
<style>
/* ----------------------------------------------
   HEADER Styling ‚Äì Titel links / Buttons rechts
---------------------------------------------- */

header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px 20px;
    background: #263238;
    color: #ffffff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.4);
    margin-bottom: 10px;
}

header .header-left {
    display: flex;
    flex-direction: column;
}

header .header-left h1 {
    margin: 0;
    font-size: 20px;
    letter-spacing: 0.5px;
}

header .header-left .subtitle {
    font-size: 11px;
    opacity: 0.7;
    margin-top: 2px;
}

header .header-right {
    display: flex;
    align-items: center;
    gap: 8px;
}

/* Navigation Buttons im Header */
.header-nav-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    background: #37474f;
    color: #ffffff;
    border-radius: 6px;
    text-decoration: none;
    font-size: 13px;
    border: 1px solid rgba(255,255,255,0.1);
    cursor: pointer;
}

.header-nav-btn:hover {
    background: #455a64;
}

/* Utility-Buttons im Header (z.B. PDF, Kommentar) */
.header-utility-btn {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 6px 10px;
    background: #455a64;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    border: 1px solid rgba(0,0,0,0.3);
}

.header-utility-btn span {
    margin-top: 1px;
}

/* ----------------------------------------------
   Grundlayout, BODY
---------------------------------------------- */

body {
    margin: 0;
    padding: 0;
    font-family: "Segoe UI", Arial, sans-serif;
    background: #eceff1;
    color: #263238;
}

/* ----------------------------------------------
   Hauptcontainer
---------------------------------------------- */

.main-container {
    max-width: 1200px;
    margin: 0 auto 40px auto;
    padding: 0 15px;
}

/* ----------------------------------------------
   Karten, Bl√∂cke
---------------------------------------------- */

.card {
    background: #ffffff;
    border-radius: 10px;
    padding: 14px 16px;
    margin: 10px 0;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.card h2 {
    margin-top: 0;
    font-size: 18px;
    border-bottom: 1px solid #eceff1;
    padding-bottom: 4px;
}

/* ----------------------------------------------
   Formular-Layout
---------------------------------------------- */

.form-grid-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px 16px;
}

.form-grid-2 label {
    font-size: 13px;
    margin-bottom: 2px;
    display: block;
}

.form-grid-2 input,
.form-grid-2 select,
.form-grid-2 textarea {
    width: 100%;
    padding: 6px;
    font-size: 13px;
    border-radius: 4px;
    border: 1px solid #b0bec5;
}

/* Volle Breite */
.form-full {
    display: flex;
    flex-direction: column;
    margin-top: 10px;
}

.form-full label {
    font-size: 13px;
    margin-bottom: 2px;
}

.form-full textarea {
    width: 100%;
    min-height: 70px;
    padding: 6px;
    font-size: 13px;
    border-radius: 4px;
    border: 1px solid #b0bec5;
}

/* ----------------------------------------------
   Ma√ünahmen-Ansicht
---------------------------------------------- */

.massnahmen-container {
    margin-top: 12px;
}

.massnahmen-bereich {
    margin-bottom: 16px;
}

.massnahmen-bereich h3 {
    margin: 6px 0 6px 0;
    font-size: 15px;
    color: #37474f;
}

.massnahmen-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

/* Ma√ünahmenelement */
.massnahme {
    position: relative;
    background: #fafafa;
    border-radius: 8px;
    padding: 8px 10px 8px 26px;
    display: flex;
    flex-direction: column;
    border-left: 4px solid #90a4ae; /* Standardgrau */
    cursor: pointer;
}

.massnahme-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.massnahme-titel {
    font-size: 14px;
    font-weight: 600;
}

.massnahme-meta {
    font-size: 11px;
    color: #607d8b;
}

.massnahme-labels {
    display: flex;
    gap: 6px;
    font-size: 10px;
    margin-top: 4px;
}

/* Statusfarben / Pflicht / Intervall etc. */

.massnahme.pflicht {
    border-left-color: #d32f2f; /* Rot */
}

.massnahme.optional {
    border-left-color: #90a4ae; /* Grau */
}

.massnahme.intervall {
    border-left-color: #1565c0; /* Blau */
}

.massnahme.erledigt {
    background: #e8f5e9;
    border-left-color: #388e3c;
    opacity: 0.85;
}

/* DueState-Farben (√úberf√§llig, Warnung, etc.) */

.massnahme.due-warn {
    box-shadow: 0 0 0 1px #ffb300 inset;
}

.massnahme.due-over {
    box-shadow: 0 0 0 1px #d32f2f inset;
}

/* Kleiner Kreis links (Statusindikator) */

.massnahme::before {
    content: "";
    position: absolute;
    left: 10px;
    top: 12px;
    width: 7px;
    height: 7px;
    border-radius: 50%;
    background: #90a4ae;
}

.massnahme.pflicht::before {
    background: #e53935;
}

.massnahme.intervall::before {
    background: #1e88e5;
}

.massnahme.erledigt::before {
    background: #43a047;
}

/* Info-Icons, Edit-Button */

.massnahme-actions {
    display: flex;
    gap: 4px;
    align-items: center;
    margin-top: 4px;
}

.icon-btn {
    background: none;
    border: none;
    font-size: 14px;
    cursor: pointer;
    padding: 2px 4px;
}

/* Info-Textblock */

.massnahme-info {
    margin-top: 4px;
    font-size: 12px;
    padding: 6px 8px;
    border-radius: 6px;
    background: #eceff1;
}

/* ----------------------------------------------
   Buttons allgemein
---------------------------------------------- */
button {
    font-family: inherit;
}

.primary-btn {
    background: #1976d2;
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 6px 10px;
    cursor: pointer;
    font-size: 13px;
}
.primary-btn:hover {
    background: #1565c0;
}

.secondary-btn {
    background: #90a4ae;
    color: #263238;
    border: none;
    border-radius: 6px;
    padding: 6px 10px;
    cursor: pointer;
    font-size: 13px;
}
.secondary-btn:hover {
    background: #78909c;
}

.warn-btn {
    background: #e53935;
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 6px 10px;
    cursor: pointer;
    font-size: 13px;
}
.warn-btn:hover {
    background: #c62828;
}

/* ----------------------------------------------
   Modale Dialoge
---------------------------------------------- */

.modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.45);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal {
    background: #ffffff;
    border-radius: 10px;
    max-width: 420px;
    width: 95%;
    padding: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.5);
}

.modal h3 {
    margin-top: 0;
    font-size: 16px;
}

.modal label {
    font-size: 12px;
    margin-top: 6px;
    display: block;
}

.modal input,
.modal select,
.modal textarea {
    width: 100%;
    padding: 5px;
    font-size: 13px;
    border-radius: 4px;
    border: 1px solid #b0bec5;
}

/* ----------------------------------------------
   Kommentare-Bereich
---------------------------------------------- */

#kommentare_liste {
    margin-top: 8px;
    font-size: 13px;
}

.kommentar-item {
    border-bottom: 1px solid #eceff1;
    padding: 4px 0;
}

/* ----------------------------------------------
   Meldungsbereich
---------------------------------------------- */

.meldung-grid-3 {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 10px 16px;
}

.meldung-grid-3 label {
    font-size: 13px;
}

.meldung-grid-3 select,
.meldung-grid-3 input {
    width: 100%;
    padding: 6px;
    font-size: 13px;
    border-radius: 4px;
    border: 1px solid #b0bec5;
}

.meldung-extra {
    margin-top: 8px;
}

/* ----------------------------------------------
   PDF-Ausgabe-Bereich
---------------------------------------------- */

#pdf-area {
    background: #ffffff;
    padding: 10px;
    margin-top: 10px;
    border-radius: 8px;
}

/* Mobile Anpassungen */
@media (max-width: 800px) {
    .form-grid-2 {
        grid-template-columns: 1fr;
    }
    .meldung-grid-3 {
        grid-template-columns: 1fr;
    }
    header {
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
    }
    header .header-right {
        align-self: stretch;
        justify-content: flex-start;
        flex-wrap: wrap;
    }
}

</style>
</head>
<body>

<header>
    <div class="header-left">
        <h1>FEUER ‚Äì Einsatzbearbeitung &amp; Dokumentation</h1>
        <div class="subtitle">
            Lagedienst Cockpit ¬∑ Werkfeuerwehr
        </div>
    </div>
    <div class="header-right">
        <!-- Zur√ºck zur Startseite -->
        <a href="index.html" class="header-nav-btn" title="Zur Startseite">
            ‚¨ÖÔ∏è <span>Start</span>
        </a>
        <!-- PDF-Button -->
        <button class="header-utility-btn" id="btn_export_pdf">
            üìÑ <span>PDF</span>
        </button>
        <!-- Kommentar-Fokus -->
        <button class="header-utility-btn" id="btn_focus_comment">
            üí¨ <span>Kommentar</span>
        </button>
    </div>
</header>

<div class="main-container">

    <!-- Einsatzgrunddaten -->
    <div class="card">
        <h2>Einsatzgrunddaten</h2>
        <div class="form-grid-2">
            <div>
                <label for="einsatznummer">Einsatznummer</label>
                <input id="einsatznummer" type="text" placeholder="z.B. 2025-000123">
            </div>
            <div>
                <label for="einsatzstichwort">Einsatzstichwort</label>
                <input id="einsatzstichwort" type="text" placeholder="Brand, Hilfeleistung, ...">
            </div>
            <div>
                <label for="objekt">Objekt / Betrieb</label>
                <input id="objekt" type="text">
            </div>
            <div>
                <label for="ort">Ort / Werkteil</label>
                <input id="ort" type="text">
            </div>
        </div>

        <div class="form-full">
            <label for="lage_anfangs">Anfangslage</label>
            <textarea id="lage_anfangs" placeholder="Kurzbeschreibung der Lage beim Eintreffen"></textarea>
        </div>

        <div class="form-full">
            <label for="lage_fortlauf">Lageentwicklung / wesentliche Erkenntnisse</label>
            <textarea id="lage_fortlauf"></textarea>
        </div>
    </div>

    <!-- Ma√ünahmen -->
    <div class="card">
        <h2>Ma√ünahmen√ºbersicht</h2>
        <p style="font-size: 12px; opacity: 0.8;">
            Tipp: Ma√ünahmen anklicken, um sie als erledigt zu markieren. √úber ‚úé k√∂nnen Details wie Pflicht/Intervall angepasst werden.
        </p>
        <div id="massnahmenContainer" class="massnahmen-container"></div>
    </div>

    <div class="block-divider"></div>

    <!-- Kommentare -->
    <div class="card">
        <h2>Kommentare</h2>
        <div class="form-grid-2">
            <div class="form-full">
                <label for="kommentar_text">Neuer Kommentar</label>
                <textarea id="kommentar_text" placeholder="z.B. Entscheidungen, Beobachtungen, Besonderheiten"></textarea>
            </div>
            <div class="form-full">
                <label for="kommentar_autor">Autor</label>
                <input id="kommentar_autor" type="text" placeholder="Name / Funktion">
                <button class="primary-btn" id="kommentar_add" style="margin-top: 8px;">Kommentar hinzuf√ºgen</button>
            </div>
        </div>
        <div id="kommentare_liste"></div>
    </div>

    <div class="block-divider"></div>

    <!-- Meldungen / besondere Ereignisse -->
    <div class="card">
        <h2>Meldungen / besondere Ereignisse</h2>
        <div class="meldung-grid-3">
            <div>
                <label for="meldung_art">Art der Meldung</label>
                <select id="meldung_art">
                    <option value="">Bitte w√§hlen</option>
                    <option value="AS1">AS1</option>
                    <option value="AS2">AS2</option>
                    <option value="AS3">AS3</option>
                    <option value="Sonstige">Sonstige</option>
                </select>
            </div>
            <div>
                <label for="meldung_zeit">Zeitpunkt</label>
                <input id="meldung_zeit" type="datetime-local">
            </div>
            <div>
                <label for="meldung_begruendung">Begr√ºndung / Kategorie</label>
                <select id="meldung_begruendung">
                    <option value="">Bitte w√§hlen</option>
                    <option value="Prozessst√∂rung">Prozessst√∂rung</option>
                    <option value="Anlagenausfall">Anlagenausfall</option>
                    <option value="Sonstiges">Sonstiges</option>
                </select>
            </div>
        </div>
        <div class="meldung-extra">
            <label for="meldung_begruendung_text">Freitext (optional, bei Sonstiges erforderlich)</label>
            <textarea id="meldung_begruendung_text" style="display:none;"></textarea>
        </div>
    </div>

    <div class="block-divider"></div>

    <!-- PDF-Ansichtsvorbereitung -->
    <div class="card">
        <h2>PDF ‚Äì Vorschau / Exportbereich</h2>
        <p style="font-size: 12px; opacity: 0.8;">
            Der nachfolgende Bereich wird beim PDF-Export verwendet. Die Inhalte spiegeln die Eingaben aus den obenstehenden Feldern wider.
        </p>
        <div id="pdf-area">
            <h3>Einsatzdokumentation FEUER</h3>
            <p><strong>Einsatznummer:</strong> <span id="pdf_einsatznummer"></span></p>
            <p><strong>Stichwort:</strong> <span id="pdf_einsatzstichwort"></span></p>
            <p><strong>Objekt:</strong> <span id="pdf_objekt"></span></p>
            <p><strong>Ort:</strong> <span id="pdf_ort"></span></p>

            <h4>Anfangslage</h4>
            <p id="pdf_lage_anfangs"></p>

            <h4>Lageentwicklung</h4>
            <p id="pdf_lage_fortlauf"></p>

            <h4>Ma√ünahmen√ºbersicht</h4>
            <ul id="pdf_massnahmen_liste"></ul>

            <h4>Kommentare</h4>
            <ul id="pdf_kommentare_liste"></ul>

            <h4>Meldung(en)</h4>
            <p id="pdf_meldung"></p>
        </div>
    </div>

</div>

<!-- Modal: Ma√ünahme bearbeiten -->
<div class="modal-backdrop" id="editModal">
    <div class="modal">
        <h3>Ma√ünahme bearbeiten</h3>
        <label for="edit_title">Titel</label>
        <input type="text" id="edit_title">

        <label for="edit_type">Art</label>
        <select id="edit_type">
            <option value="optional">Optional</option>
            <option value="pflicht">Pflicht</option>
            <option value="intervall">Intervall</option>
        </select>

        <label for="edit_intervall">Intervall (Minuten):</label>
        <input type="number" id="edit_intervall" placeholder="nur bei Intervall relevant">

        <div class="modal-buttons">
            <button class="primary-btn" id="edit_save">Speichern</button>
            <button class="warn-btn" id="edit_reset">Ma√ünahme erneut aktivieren</button>
            <button class="secondary-btn" id="edit_cancel">Abbrechen</button>
        </div>
    </div>
</div>

<script>
// ----------------------------------------------------
// JavaScript-Logik ‚Äì FEUER
// ----------------------------------------------------

// Bereichsdefinitionen f√ºr Anzeigegruppen
const BEREICHE = [
    { id: "eintreffen", label: "Beim Eintreffen" },
    { id: "5min",      label: "Innerhalb der ersten 5 Minuten" },
    { id: "10_20_30",  label: "In den ersten 10 / 20 / 30 Minuten" },
    { id: "ende",      label: "Nach Einsatzende" }
];

let massnahmen = [
    // ----------------------------------------------------
    // BEREICH: Beim Eintreffen
    // ----------------------------------------------------
    // Pflicht
    {
        id: "m1",
        titel: "AP10 einschalten",
        bereich: "eintreffen",
        type: "pflicht",
        intervallMinutes: null,
        status: "offen",
        nextDue: null,
        dueState: "neutral",
        infoText: "",
        infoLinks: "",
        infoOpen: false
    },
    {
        id: "m2",
        titel: "Lagetool √∂ffnen",
        bereich: "eintreffen",
        type: "pflicht",
        intervallMinutes: null,
        status: "offen",
        nextDue: null,
        dueState: "neutral",
        infoText: "",
        infoLinks: "",
        infoOpen: false
    },
    {
        id: "m3",
        titel: "Einsatz an Lagetool √ºbergeben",
        bereich: "eintreffen",
        type: "optional",
        intervallMinutes: null,
        status: "offen",
        nextDue: null,
        dueState: "neutral",
        infoText: "",
        infoLinks: "",
        infoOpen: false
    },
    {
        id: "m4",
        titel: "Alarmstufe und Stichwort pr√ºfen",
        bereich: "eintreffen",
        type: "pflicht",
        intervallMinutes: null,
        status: "offen",
        nextDue: null,
        dueState: "neutral",
        infoText: "",
        infoLinks: "",
        infoOpen: false
    },
    {
        id: "m5",
        titel: "Erste R√ºckmeldung der Kr√§fte abwarten",
        bereich: "eintreffen",
        type: "optional",
        intervallMinutes: null,
        status: "offen",
        nextDue: null,
        dueState: "neutral",
        infoText: "",
        infoLinks: "",
        infoOpen: false
    },
    {
        id: "m6",
        titel: "Lagebild erfassen und dokumentieren",
        bereich: "eintreffen",
        type: "optional",
        intervallMinutes: null,
        status: "offen",
        nextDue: null,
        dueState: "neutral",
        infoText: "",
        infoLinks: "",
        infoOpen: false
    },
    {
        id: "m7",
        titel: "Besondere Gefahren (Gefahrstoffe, Anlagen) pr√ºfen",
        bereich: "eintreffen",
        type: "optional",
        intervallMinutes: null,
        status: "offen",
        nextDue: null,
        dueState: "neutral",
        infoText: "",
        infoLinks: "",
        infoOpen: false
    },
    {
        id: "m8",
        titel: "Einsatzkr√§fte und Mittel pr√ºfen (Unterdeckung / √úberdeckung)",
        bereich: "eintreffen",
        type: "optional",
        intervallMinutes: null,
        status: "offen",
        nextDue: null,
        dueState: "neutral",
        infoText: "",
        infoLinks: "",
        infoOpen: false
    },
    {
        id: "m9",
        titel: "F√ºhrungsorganisation pr√ºfen (Zugf√ºhrer, Abschnittsleiter, ELW)",
        bereich: "eintreffen",
        type: "optional",
        intervallMinutes: null,
        status: "offen",
        nextDue: null,
        dueState: "neutral",
        infoText: "",
        infoLinks: "",
        infoOpen: false
    },
    {
        id: "m10",
        titel: "Kommunikationswege sicherstellen (Funk, Telefon, R√ºckfallebene)",
        bereich: "eintreffen",
        type: "optional",
        intervallMinutes: null,
        status: "offen",
        nextDue: null,
        dueState: "neutral",
        infoText: "",
        infoLinks: "",
        infoOpen: false
    },
    {
        id: "m11",
        titel: "Zugriff auf relevante Pl√§ne (Feuerwehrpl√§ne, R&I) sicherstellen",
        bereich: "eintreffen",
        type: "optional",
        intervallMinutes: null,
        status: "offen",
        nextDue: null,
        dueState: "neutral",
        infoText: "",
        infoLinks: "",
        infoOpen: false
    },
    {
        id: "m12",
        titel: "DGL- und Videokonferenz bei best√§tigter AS3 starten",
        bereich: "eintreffen",
        type: "optional",
        intervallMinutes: null,
        status: "offen",
        nextDue: null,
        dueState: "neutral",
        infoText: "",
        infoLinks: "",
        infoOpen: false
    },

    // ----------------------------------------------------
    // BEREICH: Erste 5 Minuten
    // ----------------------------------------------------
    {
        id: "m13",
        titel: "R√ºckmeldung EL / Einsatzleiter einholen",
        bereich: "5min",
        type: "pflicht",
        intervallMinutes: null,
        status: "offen",
        nextDue: null,
        dueState: "neutral",
        infoText: "",
        infoLinks: "",
        infoOpen: false
    },
    {
        id: "m14",
        titel: "Erste Lageauswertung / Einsch√§tzung vornehmen",
        bereich: "5min",
        type: "optional",
        intervallMinutes: null,
        status: "offen",
        nextDue: null,
        dueState: "neutral",
        infoText: "",
        infoLinks: "",
        infoOpen: false
    },
    {
        id: "m15",
        titel: "Taktische Ziele mit Einsatzleiter abstimmen",
        bereich: "5min",
        type: "optional",
        intervallMinutes: null,
        status: "offen",
        nextDue: null,
        dueState: "neutral",
        infoText: "",
        infoLinks: "",
        infoOpen: false
    },
    {
        id: "m16",
        titel: "Zus√§tzliche Kr√§fte / Mittel pr√ºfen und ggf. nachfordern",
        bereich: "5min",
        type: "optional",
        intervallMinutes: null,
        status: "offen",
        nextDue: null,
        dueState: "neutral",
        infoText: "",
        infoLinks: "",
        infoOpen: false
    },
    {
        id: "m17",
        titel: "R√§umung / Evakuierung pr√ºfen (Betroffene Bereiche)",
        bereich: "5min",
        type: "optional",
        intervallMinutes: null,
        status: "offen",
        nextDue: null,
        dueState: "neutral",
        infoText: "",
        infoLinks: "",
        infoOpen: false
    },
    {
        id: "m18",
        titel: "Information an relevante interne Stellen vorbereiten",
        bereich: "5min",
        type: "optional",
        intervallMinutes: null,
        status: "offen",
        nextDue: null,
        dueState: "neutral",
        infoText: "",
        infoLinks: "",
        infoOpen: false
    },
    {
        id: "m19",
        titel: "Information an externe Stellen vorbereiten (z.B. Beh√∂rden)",
        bereich: "5min",
        type: "optional",
        intervallMinutes: null,
        status: "offen",
        nextDue: null,
        dueState: "neutral",
        infoText: "",
        infoLinks: "",
        infoOpen: false
    },
    {
        id: "m20",
        titel: "Information an KMvD veranlassen",
        bereich: "5min",
        type: "optional",
        intervallMinutes: null,
        status: "offen",
        nextDue: null,
        dueState: "neutral",
        infoText: "",
        infoLinks: "",
        infoOpen: false
    },

    // ----------------------------------------------------
    // BEREICH: 10 / 20 / 30 Minuten
    // ----------------------------------------------------
    {
        id: "m21",
        titel: "Lagefortschreibung im Lagetool pr√ºfen",
        bereich: "10_20_30",
        type: "intervall",
        intervallMinutes: 10,
        status: "offen",
        nextDue: null,
        dueState: "neutral",
        infoText: "Regelm√§√üige Aktualisierung in 10-Minuten-Intervallen.",
        infoLinks: "",
        infoOpen: false
    },
    {
        id: "m22",
        titel: "Kontrolle der Einsatzabschnitte (R√ºckmeldungen)",
        bereich: "10_20_30",
        type: "intervall",
        intervallMinutes: 20,
        status: "offen",
        nextDue: null,
        dueState: "neutral",
        infoText: "",
        infoLinks: "",
        infoOpen: false
    },
    {
        id: "m23",
        titel: "Personelle Ressourcen pr√ºfen (Abl√∂sung / Pausenplanung)",
        bereich: "10_20_30",
        type: "optional",
        intervallMinutes: null,
        status: "offen",
        nextDue: null,
        dueState: "neutral",
        infoText: "",
        infoLinks: "",
        infoOpen: false
    },
    {
        id: "m24",
        titel: "Logistikbedarf pr√ºfen (Material, Verpflegung, etc.)",
        bereich: "10_20_30",
        type: "optional",
        intervallMinutes: null,
        status: "offen",
        nextDue: null,
        dueState: "neutral",
        infoText: "",
        infoLinks: "",
        infoOpen: false
    },
    {
        id: "m25",
        titel: "Dokumentation auf Vollst√§ndigkeit pr√ºfen",
        bereich: "10_20_30",
        type: "optional",
        intervallMinutes: null,
        status: "offen",
        nextDue: null,
        dueState: "neutral",
        infoText: "",
        infoLinks: "",
        infoOpen: false
    },
    {
        id: "m26",
        titel: "Schicht√ºbergabe vorbereiten (bei ausgedehntem Einsatz)",
        bereich: "10_20_30",
        type: "optional",
        intervallMinutes: null,
        status: "offen",
        nextDue: null,
        dueState: "neutral",
        infoText: "",
        infoLinks: "",
        infoOpen: false
    },
    {
        id: "m27",
        titel: "Kommunikation mit Unternehmenskommunikation abstimmen",
        bereich: "10_20_30",
        type: "optional",
        intervallMinutes: null,
        status: "offen",
        nextDue: null,
        dueState: "neutral",
        infoText: "",
        infoLinks: "",
        infoOpen: false
    },
    {
        id: "m28",
        titel: "Dokumentation f√ºr m√∂gliche Nachbesprechung / Lessons Learned markieren",
        bereich: "10_20_30",
        type: "optional",
        intervallMinutes: null,
        status: "offen",
        nextDue: null,
        dueState: "neutral",
        infoText: "",
        infoLinks: "",
        infoOpen: false
    },
    {
        id: "m29",
        titel: "Monitoring besonderer Gefahrenpunkte (z.B. Tanks, Lagerbereiche)",
        bereich: "10_20_30",
        type: "intervall",
        intervallMinutes: 30,
        status: "offen",
        nextDue: null,
        dueState: "neutral",
        infoText: "",
        infoLinks: "",
        infoOpen: false
    },
    {
        id: "m30",
        titel: "Koordination mit weiteren Leitstellen / Nachbarwehren",
        bereich: "10_20_30",
        type: "optional",
        intervallMinutes: null,
        status: "offen",
        nextDue: null,
        dueState: "neutral",
        infoText: "",
        infoLinks: "",
        infoOpen: false
    },
    {
        id: "m31",
        titel: "Auswirkungen auf Versorgung anderer CPP feststellen",
        bereich: "10_20_30",
        type: "intervall",
        intervallMinutes: null,
        status: "offen",
        nextDue: null,
        dueState: "neutral",
        infoText: "",
        infoLinks: "",
        infoOpen: false
    },

    // ----------------------------------------------------
    // BEREICH: Nach Einsatzende
    // ----------------------------------------------------
    {
        id: "m35",
        titel: "Einr√ºcken aller Kr√§fte √ºberpr√ºfen",
        bereich: "ende",
        type: "pflicht",
        intervallMinutes: null,
        status: "offen",
        nextDue: null,
        dueState: "neutral",
        infoText: "",
        infoLinks: "",
        infoOpen: false
    },
    {
        id: "m36",
        titel: "R√§umlichkeiten ordnungsgem√§√ü verlassen",
        bereich: "ende",
        type: "pflicht",
        intervallMinutes: null,
        status: "offen",
        nextDue: null,
        dueState: "neutral",
        infoText: "",
        infoLinks: "",
        infoOpen: false
    },
    {
        id: "m37",
        titel: "Nachbereitung durchf√ºhren",
        bereich: "ende",
        type: "optional",
        intervallMinutes: null,
        status: "offen",
        nextDue: null,
        dueState: "neutral",
        infoText: "",
        infoLinks: "",
        infoOpen: false
    },
    {
        id: "m38",
        titel: "Erweitertes Lagebild ausf√ºllen & versenden",
        bereich: "eintreffen",
        type: "pflicht",
        hidden: true,
        status: "offen",
        nextDue: null,
        dueState: "neutral",
        infoText: "",
        infoLinks: "",
        infoOpen: false
    },

];

// Zustand f√ºr aktuelle Bearbeitung im Modal
let editCurrent = null;

// ----------------------------------------------------
// Render-Logik
// ----------------------------------------------------

function renderMassnahmen() {
    const container = document.getElementById("massnahmenContainer");
    container.innerHTML = "";

    BEREICHE.forEach(b => {
        const blockDiv = document.createElement("div");
        const blockTitle = document.createElement("h3");
        blockTitle.textContent = getBereichLabel(b.id);
        blockDiv.appendChild(blockTitle);

        const items = massnahmen.filter(m => m.bereich === b.id && !m.hidden);
        if (items.length === 0) {
            const empty = document.createElement("div");
            empty.textContent = "Keine Ma√ünahmen.";
            empty.style.fontSize = "13px";
            empty.style.opacity = "0.7";
            blockDiv.appendChild(empty);
        } else {
            const list = document.createElement("div");
            list.className = "massnahmen-list";

            items.forEach(m => {
                const el = document.createElement("div");
                el.className = "massnahme " + m.type;

                // Status-Klasse (erledigt)
                if (m.status === "erledigt") {
                    el.classList.add("erledigt");
                }

                // DueState -> Klasse
                if (m.dueState === "warn") {
                    el.classList.add("due-warn");
                } else if (m.dueState === "over") {
                    el.classList.add("due-over");
                }

                el.addEventListener("click", () => handleMassnahmeClick(m));

                const header = document.createElement("div");
                header.className = "massnahme-header";

                const titelSpan = document.createElement("span");
                titelSpan.className = "massnahme-titel";
                titelSpan.textContent = m.titel;

                const metaSpan = document.createElement("span");
                metaSpan.className = "massnahme-meta";
                metaSpan.textContent = buildMetaText(m);

                header.appendChild(titelSpan);
                header.appendChild(metaSpan);

                el.appendChild(header);

                const labels = document.createElement("div");
                labels.className = "massnahme-labels";

                const typeLabel = document.createElement("span");
                typeLabel.textContent =
                    m.type === "pflicht" ? "Pflicht" :
                    m.type === "intervall" ? "Intervall" : "Optional";
                labels.appendChild(typeLabel);

                el.appendChild(labels);

                const actions = document.createElement("div");
                actions.className = "massnahme-actions";

                const infoBtn = document.createElement("button");
                infoBtn.className = "icon-btn";
                infoBtn.textContent = m.infoOpen ? "‚ÑπÔ∏è-" : "‚ÑπÔ∏è+";
                infoBtn.addEventListener("click", ev => {
                    ev.stopPropagation();
                    m.infoOpen = !m.infoOpen;
                    renderMassnahmen();
                });
                actions.appendChild(infoBtn);

                const editBtn = document.createElement("button");
                editBtn.className = "icon-btn";
                editBtn.textContent = "‚úé";
                editBtn.addEventListener("click", ev => {
                    ev.stopPropagation();
                    openEditModal(m);
                });
                actions.appendChild(editBtn);

                const resetBtn = document.createElement("button");
                resetBtn.className = "icon-btn";
                resetBtn.textContent = "‚Ü∫";
                resetBtn.addEventListener("click", ev => reaktivierenMassnahme(m, ev));
                actions.appendChild(resetBtn);

                el.appendChild(actions);

                if (m.infoOpen && (m.infoText || m.infoLinks)) {
                    const infoDiv = document.createElement("div");
                    infoDiv.className = "massnahme-info";
                    infoDiv.textContent = m.infoText || "";
                    el.appendChild(infoDiv);
                }

                list.appendChild(el);
            });

            blockDiv.appendChild(list);
        }

        container.appendChild(blockDiv);
    });
}

function getBereichLabel(id) {
    const b = BEREICHE.find(x => x.id === id);
    return b ? b.label : id;
}

function buildMetaText(m) {
    let meta = "";
    if (m.type === "intervall" && m.intervallMinutes) {
        meta += "Intervall: " + m.intervallMinutes + " min";
    }
    if (m.status === "erledigt") {
        meta += (meta ? " ¬∑ " : "") + "erledigt";
    }
    return meta;
}

// ----------------------------------------------------
// Ma√ünahmen-Klick-Logik
// ----------------------------------------------------

function handleMassnahmeClick(m) {
    if (m.status === "erledigt") return;

    const nowIso = new Date().toISOString();

    if (m.type === "intervall" && m.intervallMinutes) {
        m.status   = "erledigt";
        m.dueState = "neutral";
        m.nextDue  = Date.now() + m.intervallMinutes * 60000;
    } else {
        m.status = "erledigt";
    }

    // KMvD-Abh√§ngigkeit: wenn KMvD informiert (m20), erweitertes Lagebild (m38) als Pflichtma√ünahme aktivieren
    if (m.id === "m20") {
        const lage = massnahmen.find(x => x.id === "m38");
        if (lage) {
            lage.hidden = false;
            lage.type   = "pflicht";
            lage.status = "offen";
            alert("Erweitertes Lagebild ist jetzt erforderlich. Bitte ausf√ºllen und versenden.");
        }
    }

    m.erledigtAm = nowIso;
    renderMassnahmen();
}

function reaktivierenMassnahme(m, ev) {
    ev.stopPropagation();
    m.status = "offen";
    if (m.type === "intervall" && m.intervallMinutes) {
        m.nextDue = Date.now() + m.intervallMinutes * 60000;
        m.dueState = "neutral";
    } else {
        m.nextDue = null;
        m.dueState = "neutral";
    }
    renderMassnahmen();
}

// ----------------------------------------------------
// Bearbeitungs-Modal
// ----------------------------------------------------

function openEditModal(m) {
    editCurrent = m;
    document.getElementById("edit_title").value = m.titel;
    document.getElementById("edit_type").value  = m.type;
    document.getElementById("edit_intervall").value = m.intervallMinutes || "";
    document.getElementById("editModal").style.display = "flex";
}

document.getElementById("edit_save").addEventListener("click", () => {
    if (!editCurrent) return;

    const newType = document.getElementById("edit_type").value;

    // Pflichtschutz: m1 und m2 d√ºrfen nicht auf nicht-pflicht gesetzt werden
    if ((editCurrent.id === "m1" || editCurrent.id === "m2") && newType !== "pflicht") {
        alert("Diese Ma√ünahme ist zwingend und kann nicht auf optional gesetzt werden.");
        return;
    }

    // Warnhinweis beim Herabstufen anderer Pflichtma√ünahmen
    if (editCurrent.type === "pflicht" && newType === "optional") {
        const ok = confirm("WARNUNG!\nDiese Ma√ünahme ist zwingend.\nSoll sie wirklich auf optional gesetzt werden?");
        if (!ok) return;
    }

    editCurrent.titel = document.getElementById("edit_title").value.trim();
    editCurrent.type  = newType;

    const iv = document.getElementById("edit_intervall").value.trim();
    if (editCurrent.type === "intervall") {
        const v = parseInt(iv || "0", 10);
        editCurrent.intervallMinutes = (!isNaN(v) && v > 0) ? v : null;
        if (editCurrent.intervallMinutes) {
            editCurrent.nextDue = Date.now() + editCurrent.intervallMinutes * 60000;
        }
    } else {
        editCurrent.intervallMinutes = null;
        editCurrent.nextDue = null;
    }

    document.getElementById("editModal").style.display = "none";
    renderMassnahmen();
});

document.getElementById("edit_reset").addEventListener("click", () => {
    if (!editCurrent) return;
    editCurrent.status = "offen";
    if (editCurrent.type === "intervall" && editCurrent.intervallMinutes) {
        editCurrent.nextDue = Date.now() + editCurrent.intervallMinutes * 60000;
        editCurrent.dueState = "neutral";
    } else {
        editCurrent.nextDue = null;
        editCurrent.dueState = "neutral";
    }
    document.getElementById("editModal").style.display = "none";
    renderMassnahmen();
});

document.getElementById("edit_cancel").addEventListener("click", () => {
    document.getElementById("editModal").style.display = "none";
    editCurrent = null;
});

// ----------------------------------------------------
// Kommentare
// ----------------------------------------------------

let kommentare = [];

document.getElementById("kommentar_add").addEventListener("click", () => {
    const text = document.getElementById("kommentar_text").value.trim();
    const autor = document.getElementById("kommentar_autor").value.trim();
    if (!text) return;

    const eintrag = {
        text,
        autor,
        zeit: new Date().toLocaleString()
    };
    kommentare.push(eintrag);
    document.getElementById("kommentar_text").value = "";
    renderKommentare();
});

function renderKommentare() {
    const list = document.getElementById("kommentare_liste");
    list.innerHTML = "";
    kommentare.forEach(k => {
        const div = document.createElement("div");
        div.className = "kommentar-item";
        div.textContent = `[${k.zeit}] ${k.autor ? k.autor + ": " : ""}${k.text}`;
        list.appendChild(div);
    });
}

// ----------------------------------------------------
// Meldungsfelder Logik
// ----------------------------------------------------

document.getElementById("meldung_art").addEventListener("change", toggleMeldungFields);
document.getElementById("meldung_begruendung").addEventListener("change", () => {
    const sel = document.getElementById("meldung_begruendung").value;
    document.getElementById("meldung_begruendung_text").style.display =
        (sel === "Sonstiges") ? "block" : "none";
});

// Modal-Buttons (bereits oben erg√§nzt)

function toggleMeldungFields() {
    const art = document.getElementById("meldung_art").value;
    const begruendung = document.getElementById("meldung_begruendung");
    begruendung.disabled = !art;
}

// ----------------------------------------------------
// PDF-Export
// ----------------------------------------------------

document.getElementById("btn_export_pdf").addEventListener("click", () => {
    document.getElementById("pdf_einsatznummer").textContent =
        document.getElementById("einsatznummer").value;
    document.getElementById("pdf_einsatzstichwort").textContent =
        document.getElementById("einsatzstichwort").value;
    document.getElementById("pdf_objekt").textContent =
        document.getElementById("objekt").value;
    document.getElementById("pdf_ort").textContent =
        document.getElementById("ort").value;

    document.getElementById("pdf_lage_anfangs").textContent =
        document.getElementById("lage_anfangs").value;
    document.getElementById("pdf_lage_fortlauf").textContent =
        document.getElementById("lage_fortlauf").value;

    const pdfMassnahmen = document.getElementById("pdf_massnahmen_liste");
    pdfMassnahmen.innerHTML = "";
    massnahmen.forEach(m => {
        if (m.status === "erledigt") {
            const li = document.createElement("li");
            li.textContent = `${m.titel} (${m.bereich})`;
            pdfMassnahmen.appendChild(li);
        }
    });

    const pdfKommentare = document.getElementById("pdf_kommentare_liste");
    pdfKommentare.innerHTML = "";
    kommentare.forEach(k => {
        const li = document.createElement("li");
        li.textContent = `[${k.zeit}] ${k.autor ? k.autor + ": " : ""}${k.text}`;
        pdfKommentare.appendChild(li);
    });

    const art = document.getElementById("meldung_art").value;
    const zeit = document.getElementById("meldung_zeit").value;
    const begr = document.getElementById("meldung_begruendung").value;
    const begrText = document.getElementById("meldung_begruendung_text").value.trim();

    let meldungsText = "";
    if (art || zeit || begr || begrText) {
        meldungsText = `Art: ${art || "-"}, Zeit: ${zeit || "-"}, Grund: ${begr || "-"}`;
        if (begr === "Sonstiges" && begrText) {
            meldungsText += `, Kommentar: ${begrText}`;
        }
    }
    document.getElementById("pdf_meldung").textContent = meldungsText;

    const element = document.getElementById("pdf-area");
    const opt = {
        margin:       10,
        filename:     "Einsatz_FEUER.pdf",
        image:        { type: "jpeg", quality: 0.98 },
        html2canvas:  { scale: 2 },
        jsPDF:        { unit: "mm", format: "a4", orientation: "portrait" }
    };
    html2pdf().set(opt).from(element).save();
});

// Kommentar-Fokus-Button
document.getElementById("btn_focus_comment").addEventListener("click", () => {
    document.getElementById("kommentar_text").focus();
});

// Initiales Rendern
renderMassnahmen();

</script>

</body>
</html>
